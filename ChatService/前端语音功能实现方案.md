# 前端语音功能实现方案

## 概述

本文档描述如何在前端实现语音录制、上传和语音识别功能，与 ChatService 后端集成。

## 功能需求

1. **语音录制**：使用浏览器录音API录制语音
2. **语音上传**：上传语音文件到服务器
3. **语音识别**：自动或手动将语音转换为文字
4. **语音播放**：在聊天界面播放接收到的语音消息
5. **SignalR集成**：通过 SignalR 实时发送和接收语音消息

---

## 1. 语音录制

### 1.1 使用 MediaRecorder API

**浏览器兼容性检查：**
- 检查 `navigator.mediaDevices.getUserMedia` 是否支持
- 检查 `MediaRecorder` API 是否支持

**推荐的音频格式：**
- **首选**：`audio/webm` (Chrome, Edge, Opera)
- **备选**：`audio/ogg` (Firefox)
- **兜底**：`audio/wav` (所有浏览器，但文件较大)

**实现步骤：**
1. 调用 `navigator.mediaDevices.getUserMedia({ audio: true })` 获取麦克风权限
2. 创建 `MediaRecorder` 实例，指定音频格式
3. 监听 `ondataavailable` 事件收集音频数据块
4. 调用 `start()` 开始录制
5. 调用 `stop()` 停止录制
6. 将所有数据块合并为 `Blob` 对象
7. 使用 `URL.createObjectURL()` 创建临时URL用于预览

**注意事项：**
- 需要HTTPS环境（localhost除外）
- 需要用户授权麦克风权限
- 录制过程中显示录制状态指示器
- 停止录制后释放音频轨道资源

---

## 2. 语音文件上传

### 2.1 上传到服务器

**API端点：**
```
POST /api/voice/upload
Authorization: Bearer {JWT_TOKEN}
Content-Type: multipart/form-data
```

**请求参数：**
- `file` (File): 语音文件
- `recognize` (boolean, 可选): 是否自动进行语音识别，默认 false
- `language` (string, 可选): 识别语言代码，默认 "zh-CN"

**响应格式：**
```json
{
  "filePath": "voices/20241106120000_abc123def456.webm",
  "fileUrl": "http://localhost:9293/voices/20241106120000_abc123def456.webm",
  "fileName": "recording.webm",
  "fileSize": 123456,
  "uploadedAt": "2024-11-06T12:00:00Z",
  "recognizedText": "识别出的文字内容",  // 如果启用识别
  "recognitionStatus": "success"  // "success" 或 "failed"
}
```

**实现步骤：**
1. 将录制的 `Blob` 转换为 `File` 对象
2. 创建 `FormData`，添加文件和其他参数
3. 使用 `fetch` 或 `axios` 发送 POST 请求
4. 在请求头中添加 `Authorization: Bearer {token}`
5. 处理上传进度（可选，使用 `XMLHttpRequest` 的 `upload.onprogress`）
6. 接收服务器响应，获取文件路径和URL

**错误处理：**
- 文件大小限制（10MB）
- 不支持的文件格式
- 网络错误
- 服务器错误

---

## 3. 语音识别

### 3.1 自动识别（上传时）

在上传语音文件时，设置 `recognize=true`，服务器会自动进行语音识别并返回识别结果。

### 3.2 手动识别（上传后）

**API端点：**
```
POST /api/voice/recognize
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/x-www-form-urlencoded
```

**请求参数：**
- `filePath` (string): 语音文件的相对路径
- `language` (string, 可选): 识别语言代码，默认 "zh-CN"

**响应格式：**
```json
{
  "filePath": "voices/xxx.webm",
  "recognizedText": "识别出的文字内容",
  "recognitionStatus": "success",
  "language": "zh-CN"
}
```

**使用场景：**
- 用户上传语音后，可以选择手动触发识别
- 对于之前上传的语音，可以重新识别

---

## 4. 通过 SignalR 发送语音消息

### 4.1 发送私聊语音消息

```javascript
await connection.invoke('SendPrivateVoiceMessage', 
    toUserId,        // 接收者用户ID
    voiceFilePath,   // 语音文件路径（从上传接口获取）
    voiceFileUrl,    // 语音文件访问URL（可选）
    duration,        // 语音时长（秒，可选）
    recognizedText   // 语音识别文字（可选）
);
```

### 4.2 发送群聊语音消息

```javascript
await connection.invoke('SendGroupVoiceMessage', 
    groupId,         // 群组ID
    voiceFilePath,
    voiceFileUrl,
    duration,
    recognizedText
);
```

### 4.3 发送频道语音消息

```javascript
await connection.invoke('SendChannelVoiceMessage', 
    channelId,       // 频道ID
    voiceFilePath,
    voiceFileUrl,
    duration,
    recognizedText
);
```

**实现流程：**
1. 录制语音
2. 上传语音文件到服务器，获取 `filePath` 和 `fileUrl`
3. （可选）进行语音识别，获取 `recognizedText`
4. 调用 SignalR 方法发送语音消息
5. 接收确认或错误响应

---

## 5. 接收和播放语音消息

### 5.1 接收语音消息

通过 SignalR 接收消息时，语音消息的格式如下：

```json
{
  "Id": "message123",
  "Type": "private",  // "private", "group", "channel"
  "FromUserId": "user123",
  "ToUserId": "user456",
  "GroupId": null,
  "Content": "识别出的文字",  // 如果有识别文字
  "CreatedAt": "2024-11-06T12:00:00Z",
  "MessageType": "voice",  // 消息类型：文本为 "text"，语音为 "voice"
  "VoiceFilePath": "voices/xxx.webm",
  "VoiceFileUrl": "http://localhost:9293/voices/xxx.webm",
  "VoiceDuration": 10,  // 时长（秒）
  "RecognizedText": "识别出的文字内容"
}
```

### 5.2 播放语音

**使用 HTML5 Audio 元素：**
```javascript
const audio = new Audio(voiceFileUrl);
audio.play();
```

**使用 AudioContext（高级功能）：**
- 显示播放进度
- 波形可视化
- 播放速度控制

**UI组件建议：**
- 播放/暂停按钮
- 进度条
- 时长显示
- 波形图（可选）

---

## 6. UI/UX 设计建议

### 6.1 录制界面

**元素：**
- 录制按钮（开始/停止）
- 录制状态指示器（动画效果）
- 录制时长显示
- 预览播放器

**交互流程：**
1. 点击录制按钮 → 请求麦克风权限
2. 开始录制 → 按钮变为红色，显示"正在录制"
3. 停止录制 → 显示预览播放器
4. 确认后上传，取消则重新录制

### 6.2 聊天界面

**语音消息显示：**
- 语音图标标识
- 播放/暂停按钮
- 进度条和时长
- 识别文字（如果有）显示在下方
- 下载按钮（可选）

**消息气泡样式：**
- 语音消息使用不同的背景色
- 显示"语音消息"标签
- 如果有识别文字，可展开/收起显示

### 6.3 上传进度

**显示上传进度：**
- 进度条或百分比
- 上传状态文字提示
- 失败时显示重试按钮

---

## 7. 技术选型

### 7.1 录音库（可选）

如果需要更多功能，可以使用第三方库：
- **RecordRTC**: 功能强大，支持多种格式
- **MediaRecorder.js**: 跨浏览器兼容性封装
- **wavesurfer.js**: 波形可视化

### 7.2 HTTP 客户端

- **原生 fetch API**: 轻量，现代浏览器支持
- **axios**: 功能丰富，更好的错误处理
- **XMLHttpRequest**: 支持上传进度

### 7.3 SignalR 客户端

- **@microsoft/signalr**: 官方 .NET SignalR 客户端
- **signalr**: JavaScript SignalR 客户端

---

## 8. 错误处理

### 8.1 常见错误场景

1. **麦克风权限被拒绝**
   - 提示用户授权
   - 提供设置说明链接

2. **浏览器不支持录音**
   - 检测兼容性
   - 提示用户升级浏览器

3. **上传失败**
   - 显示错误信息
   - 提供重试功能
   - 本地保存录音（可选）

4. **网络断开**
   - 检测网络状态
   - 暂停上传，等待网络恢复
   - 队列管理（可选）

5. **语音识别失败**
   - 允许手动输入文字
   - 显示"识别失败，可手动输入"

---

## 9. 性能优化

### 9.1 文件压缩

- 使用适当的音频格式和比特率
- 前端压缩（使用 Web Audio API）
- 限制录制时长

### 9.2 缓存策略

- 缓存已上传的语音文件URL
- 使用 Service Worker 缓存（可选）

### 9.3 用户体验

- 上传过程中显示加载状态
- 支持取消上传
- 后台上传（不阻塞UI）

---

## 10. 安全考虑

### 10.1 文件验证

- 前端验证文件大小（10MB限制）
- 验证文件格式（仅允许音频格式）
- 后端也有验证，前端验证是提升用户体验

### 10.2 权限管理

- JWT Token 认证
- 验证用户是否有权限发送消息
- 验证文件所有权

---

## 11. 完整流程示例

### 发送语音消息流程：

```
1. 用户点击录制按钮
   ↓
2. 请求麦克风权限
   ↓
3. 开始录制（显示录制状态）
   ↓
4. 用户停止录制
   ↓
5. 显示预览播放器
   ↓
6. 用户确认上传
   ↓
7. 上传到 /api/voice/upload（可选择是否识别）
   ↓
8. 获取 filePath 和 fileUrl
   ↓
9. 调用 SignalR SendPrivateVoiceMessage/SendGroupVoiceMessage/SendChannelVoiceMessage
   ↓
10. 消息发送成功，显示在聊天界面
```

### 接收语音消息流程：

```
1. SignalR 接收到 ReceivePrivateMessage/ReceiveGroupMessage/ReceiveChannelMessage
   ↓
2. 检查 MessageType === "voice"
   ↓
3. 渲染语音消息UI（播放按钮、时长、识别文字）
   ↓
4. 用户点击播放
   ↓
5. 使用 voiceFileUrl 播放音频
```

---

## 12. 配置说明

### 后端配置

在 `appsettings.json` 中配置：
- `VoiceStorage:Path`: 语音文件存储路径（可选，默认 wwwroot/voices）
- `VoiceRecognition:Azure:SubscriptionKey`: Azure Speech Service 订阅密钥（必需）
- `VoiceRecognition:Azure:Region`: Azure 服务区域，默认为 "eastasia"

### 前端配置

- API 基础URL
- JWT Token（从 UserManager 获取）
- SignalR 连接地址

---

## 13. 测试建议

### 功能测试

- 录制功能（不同浏览器）
- 上传功能（成功/失败场景）
- 语音识别（成功/失败场景）
- SignalR 消息发送和接收
- 播放功能

### 兼容性测试

- Chrome/Edge（WebM）
- Firefox（Ogg）
- Safari（WAV）
- 移动端浏览器

### 性能测试

- 大文件上传
- 并发上传
- 长时间录制

---

## 总结

前端实现语音功能主要包括：
1. **录音**：使用 MediaRecorder API
2. **上传**：调用 `/api/voice/upload` 接口
3. **识别**：上传时自动识别或调用 `/api/voice/recognize` 手动识别
4. **发送**：通过 SignalR 发送语音消息
5. **接收**：监听 SignalR 消息，播放语音
6. **UI/UX**：友好的用户界面和交互体验

按照以上方案实现，即可完成完整的语音输入功能。

