## 项目架构与设计总结

### 整体架构
- **微服务划分**
  - `UserManager`: 用户注册、登录、资料、验证码、JWT 颁发
  - `ForumManager`: 帖子、评论、点赞、收藏
  - `MatchingService`: 标签管理、用户匹配、推荐
  - `ChatService`: 即时通信（私聊/群聊/频道）、在线状态、消息历史
- **通信方式**
  - **REST API**: 各服务独立暴露，统一使用 JWT 鉴权
  - **实时通信**: `ChatService` 使用 SignalR Hub 进行双向通信
- **数据存储**
  - **PostgreSQL + EF Core**: `UserManager`、`ForumManager`、`MatchingService`
  - **MongoDB**: `ChatService` 持久化聊天消息
  - **Redis**: 验证码/缓存/在线状态与群成员缓存
- **部署与配置**
  - 多 `sln` 工程；`Dockerfile`、`docker-compose`；`appsettings.*.json` 环境化配置；Swagger 暴露 API 文档

### 核心设计模式与实践
- **DDD 分层**: Domain / Infrastructure / WebAPI 清晰分层
- **Repository 模式**: 抽象数据访问，解耦领域与持久化（EF Core/Mongo 实现）
- **领域服务（Domain Service）**: 复杂业务规则集中（如帖子创建/编辑/权限/校验）
- **中介者（MediatR）**: 应用行为与领域事件解耦
- **中间件管道**: 统一错误处理与权限控制（异常处理中间件、管理员校验等）
- **身份鉴别与授权**: 统一 JWT（`JwtBearer`），SignalR 通过 `?access_token=` 适配
- **缓存策略**: Redis 优先，缺失/失败回退内存缓存；群成员、会话、匹配结果等缓存
- **索引与性能优化**: 聊天消息集合建立复合索引优化历史分页查询
- **自动迁移/建库**: 启动期自动迁移（带重试与失败策略）或建库

### 设计方法
- **边界清晰**: 按业务域拆分服务，最小化耦合
- **一致的横切关注点**: 认证、日志、CORS、Swagger、模型校验在各服务中一致化
- **可观测与可运维**: 启动期日志、迁移日志、Swagger 文档、错误处理
- **弹性与回退**: Redis/依赖调用/迁移等提供超时、重试与降级策略

### 关键设计难点与应对
- **跨服务统一认证与实时信令鉴权**
  - 难点：HTTP 与 SignalR 同时统一到 JWT；连接与重连的 Token 传递
  - 应对：HTTP 用 `Authorization`，SignalR 在 `JwtBearerEvents.OnMessageReceived` 解析 `?access_token=`，Hub 加 `[Authorize]`
- **即时通信的可靠性与扩展性**
  - 难点：私聊/群聊/频道三类消息、在线状态一致性、历史查询性能
  - 应对：SignalR 分组转发；MongoDB 存储并加复合索引；Presence 连接/断开事件驱动；回执与日志
- **群成员校验的跨服务依赖与性能**
  - 难点：`ChatService` 校验成员信息依赖 `UserManager`
  - 应对：HTTP 拉取后写入 `GroupMemberCache`，先查缓存，外部请求设置超时、失败快速返回，降低耦合
- **多数据库技术并存**
  - 难点：关系型与文档型并存、迁移策略不同
  - 应对：EF Core 负责关系域；Mongo 负责高吞吐消息域；分别提供迁移/建库流程
- **上线迁移稳定性**
  - 难点：迁移失败影响发布
  - 应对：可重试与“失败是否阻断启动”的配置；自动迁移并记录日志

### 采用的技术栈
- **后端框架**: .NET 8、ASP.NET Core WebAPI、SignalR
- **数据访问**: EF Core（PostgreSQL/Npgsql）、MongoDB.Driver
- **缓存/会话**: StackExchange.Redis、分布式缓存接口
- **中介者**: MediatR
- **安全**: JWT Bearer、基于声明的授权
- **接口文档**: Swashbuckle/Swagger
- **部署**: Docker / Docker Compose、环境化配置
- **其他**: CORS、HttpClientFactory、模型验证过滤器、启动期迁移/建库

### 已攻克的典型问题
- 统一 JWT 在 REST 与 SignalR 的携带与验证，覆盖断线重连
- 聊天消息在高并发下的历史分页性能（复合索引、时间倒序分页）
- 在线状态与多连接管理（同一用户多连接聚合与离线判定）
- 跨服务群成员关系的低延迟校验与缓存命中策略（超时/失败降级）
- 启动期数据库迁移的可靠性与可配置失败策略（避免阻断发布）
- Redis 不可用场景的回退策略，保障服务可用性

### 小结
架构采用领域驱动的微服务体系：清晰边界、统一认证、按域选择最合适的数据存储，结合缓存与索引保障性能，并通过中间件、迁移流程与降级设计增强健壮性与可运维性。

