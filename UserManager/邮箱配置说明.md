# 邮箱配置说明

## 问题现象

调用发送邮箱验证码接口时，返回"验证码已发送到您的邮箱"，但实际上邮件没有发送成功。

## 原因分析

邮件发送失败通常是因为 SMTP 配置不正确，特别是**邮箱授权码**配置错误。

## 解决方案

### 1. 获取 QQ 邮箱 SMTP 授权码

如果使用 QQ 邮箱作为发件邮箱，需要按以下步骤获取授权码：

1. 登录 QQ 邮箱网页版（mail.qq.com）
2. 点击顶部的【设置】→【账户】
3. 找到【POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务】
4. 开启【IMAP/SMTP服务】或【POP3/SMTP服务】
5. 点击【生成授权码】
6. 通过手机短信验证后，会得到一个**16位的授权码**（例如：`abcdabcdabcdabcd`）
7. **注意**：这个授权码不是你的 QQ 密码，而是专门用于第三方客户端登录的授权码

### 2. 配置 appsettings.json

将获取到的授权码配置到 `UserManager.WebAPI/appsettings.json` 文件中：

```json
{
  "Email": {
    "SmtpHost": "smtp.qq.com",
    "SmtpPort": "587",
    "SenderEmail": "你的QQ邮箱@qq.com",
    "SenderPassword": "你获取的16位授权码",
    "SenderName": "用户管理系统"
  }
}
```

**重要提示**：
- `SenderEmail`：填写你的完整 QQ 邮箱地址
- `SenderPassword`：填写刚才获取的**16位授权码**，不是 QQ 登录密码
- `SmtpHost`：QQ 邮箱固定为 `smtp.qq.com`
- `SmtpPort`：使用 `587`（TLS加密）或 `465`（SSL加密）

### 3. 使用其他邮箱服务商

如果使用其他邮箱服务，请参考以下配置：

#### 网易163邮箱
```json
{
  "Email": {
    "SmtpHost": "smtp.163.com",
    "SmtpPort": "465",
    "SenderEmail": "你的163邮箱@163.com",
    "SenderPassword": "你的授权码",
    "SenderName": "用户管理系统"
  }
}
```

#### Gmail
```json
{
  "Email": {
    "SmtpHost": "smtp.gmail.com",
    "SmtpPort": "587",
    "SenderEmail": "your-email@gmail.com",
    "SenderPassword": "应用专用密码",
    "SenderName": "User Management System"
  }
}
```

#### 企业邮箱（如腾讯企业邮）
```json
{
  "Email": {
    "SmtpHost": "smtp.exmail.qq.com",
    "SmtpPort": "465",
    "SenderEmail": "your-email@yourcompany.com",
    "SenderPassword": "邮箱密码或授权码",
    "SenderName": "用户管理系统"
  }
}
```

### 4. 配置开发环境和生产环境

为了方便开发，可以分别配置不同环境的邮箱：

**appsettings.Development.json**（开发环境）：
```json
{
  "Email": {
    "SmtpHost": "smtp.qq.com",
    "SmtpPort": "587",
    "SenderEmail": "dev@qq.com",
    "SenderPassword": "开发环境授权码",
    "SenderName": "用户管理系统[开发]"
  }
}
```

**appsettings.Production.json**（生产环境）：
```json
{
  "Email": {
    "SmtpHost": "smtp.exmail.qq.com",
    "SmtpPort": "465",
    "SenderEmail": "noreply@yourcompany.com",
    "SenderPassword": "生产环境授权码",
    "SenderName": "用户管理系统"
  }
}
```

### 5. 测试邮件发送

配置完成后，重启应用程序，然后：

1. 调用 `POST /api/Login/SendRegisterEmailCode` 接口
2. 查看控制台日志：
   - 成功：显示 `验证码邮件已发送到: xxx@xxx.com`
   - 失败：显示 `[开发模拟] 向 xxx@xxx.com 发送验证码: xxxxxx` 和错误信息
3. 检查收件箱（包括垃圾邮件箱）

### 6. 常见问题

#### 问题1：授权码失效
**解决方案**：重新生成授权码并更新配置

#### 问题2：邮件进入垃圾箱
**解决方案**：
- 将发件邮箱添加到通讯录
- 标记为"非垃圾邮件"
- 使用企业邮箱可以避免此问题

#### 问题3：端口连接失败
**解决方案**：
- 尝试更换端口（587 或 465）
- 检查服务器防火墙是否开放了 SMTP 端口
- 如果在云服务器上，检查安全组规则

#### 问题4：身份验证失败
**解决方案**：
- 确认使用的是授权码而不是登录密码
- 确认邮箱地址和授权码匹配
- 检查 SMTP 服务是否已开启

### 7. 安全建议

⚠️ **重要**：不要将真实的邮箱授权码直接写在 `appsettings.json` 中并提交到版本控制系统！

**推荐做法**：

1. **使用环境变量**：
   ```bash
   # Linux/Mac
   export Email__SenderPassword="your_authorization_code"
   
   # Windows PowerShell
   $env:Email__SenderPassword="your_authorization_code"
   ```

2. **使用用户机密（User Secrets）**（开发环境）：
   ```bash
   dotnet user-secrets set "Email:SenderPassword" "your_authorization_code"
   ```

3. **使用 Azure Key Vault 或 AWS Secrets Manager**（生产环境）

4. **修改 .gitignore**，确保包含：
   ```
   appsettings.Production.json
   appsettings.*.json
   ```

## 验证配置是否成功

修改配置后，重启应用程序并查看启动日志。如果配置正确，发送验证码时会在控制台看到类似信息：

```
info: UserManager.Infrastracture.EmailCodeSender[0]
      验证码邮件已发送到: user@example.com
```

如果配置错误，会看到错误信息：

```
fail: UserManager.Infrastracture.EmailCodeSender[0]
      发送验证码邮件失败: user@example.com
      System.Net.Mail.SmtpException: ...
[开发模拟] 向 user@example.com 发送验证码: 123456
```

## 相关文件

- 邮件发送实现：`UserManager.Infrastracture/EmailCodeSender.cs`
- 配置文件：`UserManager.WebAPI/appsettings.json`
- 服务注册：`UserManager.WebAPI/Program.cs`

## 更新日志

- **2025-10-18**: 初始版本，添加邮箱配置说明


