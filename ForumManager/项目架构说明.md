# 论坛服务架构说明

## 项目结构

```
ForumManager/
├── ForumManager.Domain/              # 领域层
│   ├── Entities/                     # 实体
│   │   ├── Post.cs                   # 帖子实体
│   │   ├── Comment.cs                # 评论实体
│   │   ├── PostLike.cs               # 帖子点赞实体
│   │   ├── PostFavorite.cs           # 帖子收藏实体
│   │   └── CommentLike.cs            # 评论点赞实体
│   ├── ValueObjects/                 # 值对象
│   │   └── PostCategory.cs           # 帖子分类枚举
│   ├── Events/                       # 领域事件
│   │   ├── PostCreatedEvent.cs       # 帖子创建事件
│   │   └── CommentAddedEvent.cs      # 评论添加事件
│   ├── IForumRepository.cs           # 仓储接口
│   └── ForumDomainService.cs         # 领域服务
├── ForumManager.Infrastructure/      # 基础设施层
│   ├── ForumDBContext.cs             # EF Core 数据库上下文
│   ├── ForumRepository.cs            # 仓储实现
│   ├── RedisForumCache.cs            # Redis 缓存服务
│   └── Migrations/                   # 数据库迁移
├── ForumManager.WebAPI/              # Web API 层
│   ├── Controllers/                  # 控制器
│   │   ├── PostsController.cs        # 帖子控制器
│   │   └── CommentsController.cs     # 评论控制器
│   ├── Models/                       # 请求/响应模型
│   │   ├── Requests/                 # 请求模型
│   │   └── Responses/                # 响应模型
│   ├── Events/                       # 事件处理器
│   │   ├── PostCreatedEventHandler.cs
│   │   └── CommentAddedEventHandler.cs
│   └── Program.cs                    # 程序入口
└── ForumManager.sln                  # 解决方案文件
```

## 技术架构

### 1. 领域驱动设计 (DDD)
- **实体 (Entities)**: Post, Comment, PostLike, PostFavorite, CommentLike
- **值对象 (Value Objects)**: PostCategory, PostStatus 枚举
- **领域服务**: ForumDomainService 处理复杂业务逻辑
- **仓储接口**: IForumRepository 定义数据访问契约

### 2. 基础设施层
- **EF Core + PostgreSQL**: 关系型数据库，支持复杂查询
- **Redis**: 高性能缓存，用于热门帖子、帖子详情等
- **仓储模式**: 封装数据访问逻辑

### 3. Web API 层
- **RESTful API**: 标准的 REST 接口设计
- **JWT 认证**: 安全的用户认证机制
- **Swagger**: API 文档自动生成
- **事件驱动**: 使用 MediatR 处理领域事件

## 核心功能

### 帖子管理
- ✅ 发布、编辑、删除帖子
- ✅ 帖子分类（学习搭子、运动组队、技术讨论等）
- ✅ 标签系统
- ✅ 分页查询和搜索
- ✅ 热门帖子算法

### 评论系统
- ✅ 添加、编辑、删除评论
- ✅ 嵌套回复功能
- ✅ 评论点赞

### 互动功能
- ✅ 帖子点赞/取消点赞
- ✅ 帖子收藏/取消收藏
- ✅ 浏览次数统计

## 性能优化

### Redis 缓存策略
- **帖子详情**: 5分钟缓存，减少数据库查询
- **热门帖子**: 10分钟缓存，提升首页加载速度
- **用户权限**: 基于JWT的缓存策略

### 数据库优化
- **索引设计**: 针对常用查询字段建立索引
- **分页查询**: 使用 Skip/Take 实现高效分页
- **热门算法**: 综合浏览量、点赞数、评论数计算热度

## 事件驱动架构

### 领域事件
1. **PostCreatedEvent**: 帖子创建时触发
   - 可用于发送通知
   - 更新搜索索引
   - 统计用户活跃度

2. **CommentAddedEvent**: 评论添加时触发
   - 通知帖子作者
   - 通知被回复的用户
   - 更新帖子热度分数

### 事件处理器
- 使用 MediatR 实现松耦合的事件处理
- 支持异步处理，提升系统响应性能
- 易于扩展新的事件处理逻辑

## 部署配置

### 环境要求
- .NET 8.0 Runtime
- PostgreSQL 12+
- Redis 6+

### 配置说明
```json
{
  "ConnectionStrings": {
    "ForumConnection": "Host=localhost;Database=ForumDB;Username=postgres;Password=123456",
    "Redis": "localhost:6379"
  },
  "Jwt": {
    "SecretKey": "YourSecretKey",
    "Issuer": "ForumManagerAPI",
    "Audience": "ForumManagerClient",
    "ExpiryInMinutes": 60
  }
}
```

## API 端点概览

### 帖子相关
- `GET /api/posts` - 获取帖子列表
- `GET /api/posts/hot` - 获取热门帖子
- `GET /api/posts/{id}` - 获取帖子详情
- `POST /api/posts` - 创建帖子
- `PUT /api/posts/{id}` - 编辑帖子
- `DELETE /api/posts/{id}` - 删除帖子
- `POST /api/posts/{id}/like` - 点赞帖子
- `POST /api/posts/{id}/favorite` - 收藏帖子

### 评论相关
- `GET /api/comments/post/{postId}` - 获取帖子评论
- `GET /api/comments/{id}` - 获取评论详情
- `POST /api/comments` - 添加评论
- `PUT /api/comments/{id}` - 编辑评论
- `DELETE /api/comments/{id}` - 删除评论
- `POST /api/comments/{id}/like` - 点赞评论

## 扩展性设计

### 微服务架构
- 独立的论坛服务，可与其他服务解耦
- 通过事件总线与其他服务通信
- 支持独立部署和扩展

### 水平扩展
- 无状态设计，支持负载均衡
- Redis 缓存支持集群部署
- PostgreSQL 支持读写分离

### 功能扩展
- 插件化的事件处理机制
- 灵活的标签和分类系统
- 易于添加新的互动功能
