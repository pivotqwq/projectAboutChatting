# 论坛管理微服务 - 程序员操作手册

## 目录
1. [项目概述](#项目概述)
2. [开发环境搭建](#开发环境搭建)
3. [项目结构说明](#项目结构说明)
4. [数据库操作](#数据库操作)
5. [代码开发指南](#代码开发指南)
6. [部署和运维](#部署和运维)
7. [常见问题和解决方案](#常见问题和解决方案)

## 项目概述

论坛管理微服务是一个基于 .NET 8 的现代化论坛系统，采用DDD（领域驱动设计）架构，提供完整的论坛功能。

### 技术栈
- **后端框架**: .NET 8 Web API
- **数据库**: PostgreSQL
- **缓存**: Redis
- **ORM**: Entity Framework Core
- **认证**: JWT Bearer Token
- **文档**: Swagger/OpenAPI
- **架构模式**: DDD + CQRS + MediatR

### 核心功能
- 帖子发布、编辑、删除
- 评论系统（支持回复）
- 点赞和收藏功能
- 热门帖子算法
- 分页和搜索
- 用户权限控制

## 开发环境搭建

### 1. 系统要求
- .NET 8 SDK
- PostgreSQL 12+
- Redis 6+
- Visual Studio 2022 或 VS Code
- Git

### 2. 安装步骤

#### 2.1 克隆项目
```bash
git clone <repository-url>
cd ForumManager
```

#### 2.2 安装依赖
```bash
dotnet restore
```

#### 2.3 配置数据库
1. 安装 PostgreSQL
2. 创建数据库：
```sql
CREATE DATABASE forum_manager;
```

#### 2.4 配置 Redis
1. 安装 Redis 服务器
2. 启动 Redis：
```bash
redis-server
```

#### 2.5 配置连接字符串
编辑 `ForumManager.WebAPI/appsettings.Development.json`：

```json
{
  "ConnectionStrings": {
    "ForumConnection": "Host=localhost;Database=forum_manager;Username=postgres;Password=your_password",
    "Redis": "localhost:6379"
  },
  "Jwt": {
    "SecretKey": "your-super-secret-key-at-least-32-characters",
    "Issuer": "ForumManagerAPI",
    "Audience": "ForumManagerClient"
  }
}
```

#### 2.6 运行项目
```bash
dotnet run --project ForumManager.WebAPI
```

访问 Swagger 文档：`https://localhost:7000/swagger`

## 项目结构说明

```
ForumManager/
├── ForumManager.Domain/           # 领域层
│   ├── Entities/                  # 实体
│   │   ├── Post.cs               # 帖子实体
│   │   ├── Comment.cs            # 评论实体
│   │   ├── PostLike.cs           # 帖子点赞
│   │   ├── PostFavorite.cs       # 帖子收藏
│   │   └── CommentLike.cs        # 评论点赞
│   ├── ValueObjects/             # 值对象
│   │   └── PostCategory.cs       # 帖子分类枚举
│   ├── Events/                   # 领域事件
│   ├── IForumRepository.cs       # 仓储接口
│   └── ForumDomainService.cs     # 领域服务
├── ForumManager.Infrastructure/   # 基础设施层
│   ├── ForumDBContext.cs         # EF上下文
│   ├── ForumRepository.cs        # 仓储实现
│   ├── RedisForumCache.cs        # Redis缓存
│   └── Migrations/               # 数据库迁移
├── ForumManager.WebAPI/          # 应用层
│   ├── Controllers/              # 控制器
│   ├── Models/                   # 请求/响应模型
│   ├── Events/                   # 事件处理器
│   └── Program.cs                # 程序入口
└── 项目架构说明.md               # 架构文档
```

### 架构层次说明

#### 1. Domain Layer (领域层)
- **职责**: 核心业务逻辑和规则
- **包含**: 实体、值对象、领域服务、仓储接口
- **特点**: 不依赖任何外部框架

#### 2. Infrastructure Layer (基础设施层)
- **职责**: 数据访问、外部服务集成
- **包含**: EF上下文、仓储实现、缓存实现
- **特点**: 实现Domain层定义的接口

#### 3. WebAPI Layer (应用层)
- **职责**: API接口、请求处理、响应格式化
- **包含**: 控制器、DTO、事件处理器
- **特点**: 协调Domain和Infrastructure层

## 数据库操作

### 1. 数据库迁移

#### 创建迁移
```bash
dotnet ef migrations add MigrationName --project ForumManager.Infrastructure --startup-project ForumManager.WebAPI
```

#### 更新数据库
```bash
dotnet ef database update --project ForumManager.Infrastructure --startup-project ForumManager.WebAPI
```

#### 回滚迁移
```bash
dotnet ef database update PreviousMigrationName --project ForumManager.Infrastructure --startup-project ForumManager.WebAPI
```

### 2. 数据库脚本

#### 初始化数据
```sql
-- 插入测试分类数据（如果需要）
INSERT INTO posts (id, author_id, title, content, category, status, created_at, view_count, like_count, comment_count, favorite_count)
VALUES 
  (gen_random_uuid(), gen_random_uuid(), '测试帖子1', '这是测试内容1', 1, 2, NOW(), 0, 0, 0, 0),
  (gen_random_uuid(), gen_random_uuid(), '测试帖子2', '这是测试内容2', 2, 2, NOW(), 0, 0, 0, 0);
```

### 3. 数据库维护

#### 清理软删除数据
```sql
-- 清理已删除的帖子
DELETE FROM posts WHERE status = 3;

-- 清理已删除的评论
DELETE FROM comments WHERE is_deleted = true;
```

#### 性能优化
```sql
-- 创建索引
CREATE INDEX idx_posts_category_status ON posts(category, status);
CREATE INDEX idx_posts_author_status ON posts(author_id, status);
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);
CREATE INDEX idx_comments_post_id ON comments(post_id);
CREATE INDEX idx_post_likes_user_post ON post_likes(user_id, post_id);
```

## 代码开发指南

### 1. 添加新功能

#### 1.1 添加新的API端点
1. 在 `Controllers` 中添加新的控制器方法
2. 在 `Models/Requests` 中定义请求模型
3. 在 `Models/Responses` 中定义响应模型
4. 更新 Swagger 文档注释

#### 1.2 添加新的实体
1. 在 `Domain/Entities` 中创建实体类
2. 在 `Domain/ValueObjects` 中创建相关值对象
3. 在 `ForumDBContext` 中添加 DbSet
4. 创建数据库迁移

#### 1.3 添加新的业务逻辑
1. 在 `Domain` 层添加领域服务方法
2. 在 `Infrastructure` 层实现仓储方法
3. 在控制器中调用领域服务

### 2. 代码规范

#### 2.1 命名规范
- **类名**: PascalCase (如: `PostController`)
- **方法名**: PascalCase (如: `GetPostsAsync`)
- **属性名**: PascalCase (如: `PostId`)
- **变量名**: camelCase (如: `postId`)
- **常量**: UPPER_CASE (如: `MAX_PAGE_SIZE`)

#### 2.2 注释规范
```csharp
/// <summary>
/// 获取帖子列表
/// </summary>
/// <param name="pageIndex">页码，从0开始</param>
/// <param name="pageSize">每页数量</param>
/// <param name="category">帖子分类</param>
/// <param name="keyword">搜索关键词</param>
/// <returns>分页的帖子列表</returns>
public async Task<ActionResult<PagedResponse<PostResponse>>> GetPosts(
    [FromQuery] int pageIndex = 0,
    [FromQuery] int pageSize = 20,
    [FromQuery] PostCategory? category = null,
    [FromQuery] string? keyword = null)
```

#### 2.3 异常处理
```csharp
try
{
    // 业务逻辑
}
catch (ArgumentException ex)
{
    return BadRequest(ex.Message);
}
catch (UnauthorizedAccessException ex)
{
    return Unauthorized(ex.Message);
}
catch (Exception ex)
{
    _logger.LogError(ex, "处理请求时发生错误");
    return StatusCode(500, "服务器内部错误");
}
```

### 3. 测试

#### 3.1 单元测试
```csharp
[Test]
public async Task CreatePost_WithValidData_ReturnsCreatedPost()
{
    // Arrange
    var request = new CreatePostRequest
    {
        Title = "测试帖子",
        Content = "测试内容",
        Category = PostCategory.TechDiscussion
    };
    
    // Act
    var result = await _controller.CreatePost(request);
    
    // Assert
    Assert.IsInstanceOf<CreatedAtActionResult>(result.Result);
}
```

#### 3.2 集成测试
```csharp
[Test]
public async Task GetPosts_ReturnsPagedResults()
{
    // Arrange
    var client = _factory.CreateClient();
    
    // Act
    var response = await client.GetAsync("/api/posts?pageIndex=0&pageSize=10");
    
    // Assert
    response.EnsureSuccessStatusCode();
    var content = await response.Content.ReadAsStringAsync();
    var result = JsonSerializer.Deserialize<PagedResponse<PostResponse>>(content);
    Assert.IsNotNull(result);
}
```

## 部署和运维

### 1. 生产环境配置

#### 1.1 配置文件
```json
{
  "ConnectionStrings": {
    "ForumConnection": "Host=prod-db;Database=forum_manager;Username=prod_user;Password=secure_password",
    "Redis": "prod-redis:6379"
  },
  "Jwt": {
    "SecretKey": "production-secret-key-very-long-and-secure",
    "Issuer": "ForumManagerAPI",
    "Audience": "ForumManagerClient"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

#### 1.2 Docker 部署
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["ForumManager.WebAPI/ForumManager.WebAPI.csproj", "ForumManager.WebAPI/"]
COPY ["ForumManager.Infrastructure/ForumManager.Infrastructure.csproj", "ForumManager.Infrastructure/"]
COPY ["ForumManager.Domain/ForumManager.Domain.csproj", "ForumManager.Domain/"]
RUN dotnet restore "ForumManager.WebAPI/ForumManager.WebAPI.csproj"
COPY . .
WORKDIR "/src/ForumManager.WebAPI"
RUN dotnet build "ForumManager.WebAPI.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "ForumManager.WebAPI.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "ForumManager.WebAPI.dll"]
```

#### 1.3 Docker Compose
```yaml
version: '3.8'
services:
  forum-api:
    build: .
    ports:
      - "8080:80"
    environment:
      - ConnectionStrings__ForumConnection=Host=postgres;Database=forum_manager;Username=postgres;Password=password
      - ConnectionStrings__Redis=redis:6379
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: forum_manager
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### 2. 监控和日志

#### 2.1 健康检查
```csharp
builder.Services.AddHealthChecks()
    .AddDbContext<ForumDBContext>()
    .AddRedis(builder.Configuration.GetConnectionString("Redis"));

app.MapHealthChecks("/health");
```

#### 2.2 日志配置
```csharp
builder.Logging.ClearProviders();
builder.Logging.AddConsole();
builder.Logging.AddDebug();
builder.Logging.AddEventSourceLogger();

if (builder.Environment.IsDevelopment())
{
    builder.Logging.AddConsole();
}
```

### 3. 性能优化

#### 3.1 数据库优化
- 添加适当的索引
- 使用连接池
- 启用查询缓存
- 定期清理软删除数据

#### 3.2 缓存策略
- 热门帖子缓存10分钟
- 帖子详情缓存5分钟
- 用户权限缓存30分钟
- 使用Redis集群提高可用性

#### 3.3 API优化
- 实现分页
- 使用压缩中间件
- 启用响应缓存
- 异步处理长时间操作

## 常见问题和解决方案

### 1. 数据库连接问题

#### 问题：无法连接到PostgreSQL
**解决方案**：
1. 检查PostgreSQL服务是否启动
2. 验证连接字符串配置
3. 检查防火墙设置
4. 确认用户权限

```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 测试连接
psql -h localhost -U postgres -d forum_manager
```

### 2. Redis连接问题

#### 问题：Redis连接超时
**解决方案**：
1. 检查Redis服务状态
2. 验证Redis配置
3. 检查网络连接

```bash
# 检查Redis状态
redis-cli ping

# 查看Redis日志
sudo journalctl -u redis
```

### 3. JWT认证问题

#### 问题：Token验证失败
**解决方案**：
1. 检查JWT配置
2. 验证密钥长度（至少32字符）
3. 检查Token格式

```csharp
// 验证JWT配置
var jwtSecretKey = builder.Configuration["Jwt:SecretKey"];
if (string.IsNullOrEmpty(jwtSecretKey) || jwtSecretKey.Length < 32)
{
    throw new InvalidOperationException("JWT密钥必须至少32个字符");
}
```

### 4. 性能问题

#### 问题：API响应缓慢
**解决方案**：
1. 检查数据库查询性能
2. 启用缓存
3. 优化分页查询
4. 添加数据库索引

```sql
-- 分析慢查询
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;
```

### 5. 内存泄漏问题

#### 问题：应用内存使用持续增长
**解决方案**：
1. 检查缓存配置
2. 监控DbContext生命周期
3. 及时释放资源

```csharp
// 使用using语句确保资源释放
using var scope = serviceProvider.CreateScope();
var context = scope.ServiceProvider.GetRequiredService<ForumDBContext>();
```

### 6. 部署问题

#### 问题：容器启动失败
**解决方案**：
1. 检查Dockerfile配置
2. 验证环境变量
3. 查看容器日志

```bash
# 查看容器日志
docker logs <container_id>

# 进入容器调试
docker exec -it <container_id> /bin/bash
```

## 开发工具推荐

### 1. IDE插件
- **C# Dev Kit** (VS Code)
- **Entity Framework Core Tools**
- **PostgreSQL** (数据库管理)
- **Redis** (缓存管理)

### 2. 调试工具
- **Postman** (API测试)
- **Redis Desktop Manager** (Redis管理)
- **pgAdmin** (PostgreSQL管理)

### 3. 监控工具
- **Application Insights** (应用监控)
- **Prometheus + Grafana** (系统监控)
- **ELK Stack** (日志分析)

## 版本控制

### 1. Git工作流
```bash
# 创建功能分支
git checkout -b feature/new-feature

# 提交更改
git add .
git commit -m "feat: 添加新功能"

# 推送分支
git push origin feature/new-feature

# 创建Pull Request
```

### 2. 提交规范
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

## 联系和支持

如有问题或建议，请：
1. 查看本文档的常见问题部分
2. 搜索现有的Issues
3. 创建新的Issue
4. 联系开发团队

---

**注意**: 本文档会随着项目的发展持续更新，请定期查看最新版本。

