# 数据库介绍文档

## 项目概述

本项目是一个基于微服务架构的论坛和聊天室系统，采用多种数据库技术来满足不同服务的需求。整个系统由5个主要服务组成，每个服务使用独立的数据库，实现数据隔离和服务自治。

## 数据库架构总览

| 服务名称 | 数据库类型 | 数据库名称 | 主要用途 | 缓存 |
|---------|----------|-----------|---------|------|
| UserManager | PostgreSQL | usermanagerdb | 用户管理、认证、登录历史 | Redis |
| ForumManager | PostgreSQL | ForumDB | 论坛帖子、评论、点赞、收藏 | Redis |
| MatchingService | PostgreSQL | MatchingDB | 用户匹配、标签管理、推荐算法 | Redis |
| ChatService | MongoDB | chatdb | 实时聊天消息存储 | Redis |
| ApiGateway | - | - | API网关路由 | - |

---

## 1. UserManager 数据库 (PostgreSQL)

### 数据库配置
- **数据库名称**: `usermanagerdb`
- **DBMS**: PostgreSQL
- **默认连接**: `Host=localhost;Port=5432;Database=usermanagerdb;Username=postgres;Password=WYCHCnt4E2WAbALh`

### 表结构

#### 1.1 T_Users (用户表)
用户主表，存储用户的基本信息和认证信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 用户唯一标识 |
| Name | text | NOT NULL | 用户昵称（自动生成："用户"+6位随机字母数字） |
| UserBasic_PhoneNumber | varchar(20) | NULL | 手机号码 |
| UserBasic_Email | varchar(100) | NULL | 电子邮箱 |
| passwordHash | varchar(100) | NULL | 密码MD5哈希值 |

**特性**:
- 支持手机号或邮箱登录
- 密码采用MD5哈希存储
- 自动生成用户昵称

#### 1.2 T_UserLoginHistories (用户登录历史表)
记录用户的登录历史信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | bigint | PK, AUTO INCREMENT | 记录ID |
| UserId | uuid | NULL | 关联的用户ID |
| UserBasic_PhoneNumber | varchar(20) | NULL | 登录使用的手机号 |
| UserBasic_Email | varchar(100) | NULL | 登录使用的邮箱 |
| CreatedDateTime | timestamp with time zone | NOT NULL | 登录时间 |
| Messsage | text | NOT NULL | 登录消息/备注 |

**特性**:
- 记录每次登录的详细信息
- 支持审计和安全追踪

#### 1.3 T_UserAccessFails (用户访问失败记录表)
记录用户登录失败信息，用于账户安全保护。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 记录ID |
| UserId | uuid | FK, NOT NULL | 关联的用户ID |
| LockEnd | timestamp with time zone | NULL | 锁定结束时间 |
| AccessFailCount | integer | NOT NULL | 访问失败次数 |
| IsLockedOut | boolean | NOT NULL, DEFAULT FALSE | 是否已锁定 |

**索引**:
- UNIQUE INDEX on UserId

**外键关系**:
- UserId → T_Users(Id) [ON DELETE CASCADE]

**特性**:
- 防暴力破解机制
- 自动账户锁定功能

---

## 2. ForumManager 数据库 (PostgreSQL)

### 数据库配置
- **数据库名称**: `ForumDB`
- **DBMS**: PostgreSQL
- **默认连接**: `Host=localhost;Database=ForumDB;Username=postgres;Password=123456`

### 表结构

#### 2.1 Posts (帖子表)
论坛帖子主表。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 帖子ID |
| AuthorId | uuid | NOT NULL | 作者用户ID |
| Title | varchar(200) | NOT NULL | 帖子标题 |
| Content | varchar(10000) | NOT NULL | 帖子内容 |
| Category | int | NOT NULL | 帖子分类（枚举值） |
| Status | int | NOT NULL | 帖子状态（枚举值） |
| Tags | text | NOT NULL | 标签列表（JSON格式） |
| ViewCount | int | NOT NULL, DEFAULT 0 | 浏览次数 |
| LikeCount | int | NOT NULL, DEFAULT 0 | 点赞数 |
| CommentCount | int | NOT NULL, DEFAULT 0 | 评论数 |
| FavoriteCount | int | NOT NULL, DEFAULT 0 | 收藏数 |
| CreatedAt | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| UpdatedAt | timestamp | NULL | 更新时间 |

**索引**:
- INDEX on AuthorId
- INDEX on Category
- INDEX on Status
- INDEX on CreatedAt
- INDEX on ViewCount
- INDEX on LikeCount

**帖子分类 (PostCategory)**:
- 1: StudyPartner (找学习搭子)
- 2: SportsTeam (运动组队)
- 3: TechDiscussion (技术讨论)
- 4: LifeSharing (生活分享)
- 5: JobHunting (求职招聘)
- 99: Other (其他)

**帖子状态 (PostStatus)**:
- 1: Draft (草稿)
- 2: Published (已发布)
- 3: Deleted (已删除)
- 4: Hidden (已隐藏)

#### 2.2 Comments (评论表)
帖子评论表，支持评论回复功能。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 评论ID |
| PostId | uuid | FK, NOT NULL | 所属帖子ID |
| AuthorId | uuid | NOT NULL | 评论者用户ID |
| Content | varchar(2000) | NOT NULL | 评论内容 |
| ParentCommentId | uuid | NULL | 父评论ID（支持回复评论） |
| LikeCount | int | NOT NULL, DEFAULT 0 | 点赞数 |
| IsDeleted | boolean | NOT NULL, DEFAULT FALSE | 是否已删除 |
| CreatedAt | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| UpdatedAt | timestamp | NULL | 更新时间 |

**索引**:
- INDEX on PostId
- INDEX on AuthorId
- INDEX on ParentCommentId
- INDEX on CreatedAt
- INDEX on IsDeleted

**外键关系**:
- PostId → Posts(Id) [ON DELETE CASCADE]

#### 2.3 PostLikes (帖子点赞表)
记录用户对帖子的点赞关系。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 记录ID |
| PostId | uuid | FK, NOT NULL | 帖子ID |
| UserId | uuid | NOT NULL | 用户ID |
| CreatedAt | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 点赞时间 |

**索引**:
- INDEX on PostId
- INDEX on UserId
- UNIQUE INDEX on (PostId, UserId)

**外键关系**:
- PostId → Posts(Id) [ON DELETE CASCADE]

#### 2.4 PostFavorites (帖子收藏表)
记录用户对帖子的收藏关系。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 记录ID |
| PostId | uuid | FK, NOT NULL | 帖子ID |
| UserId | uuid | NOT NULL | 用户ID |
| CreatedAt | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 收藏时间 |

**索引**:
- INDEX on PostId
- INDEX on UserId
- UNIQUE INDEX on (PostId, UserId)

**外键关系**:
- PostId → Posts(Id) [ON DELETE CASCADE]

#### 2.5 CommentLikes (评论点赞表)
记录用户对评论的点赞关系。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 记录ID |
| CommentId | uuid | FK, NOT NULL | 评论ID |
| UserId | uuid | NOT NULL | 用户ID |
| CreatedAt | timestamp | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 点赞时间 |

**索引**:
- INDEX on CommentId
- INDEX on UserId
- UNIQUE INDEX on (CommentId, UserId)

**外键关系**:
- CommentId → Comments(Id) [ON DELETE CASCADE]

---

## 3. MatchingService 数据库 (PostgreSQL)

### 数据库配置
- **数据库名称**: `MatchingDB`
- **DBMS**: PostgreSQL
- **默认连接**: `Host=localhost;Port=5432;Database=MatchingDB;Username=postgres;Password=123456`

### 表结构

#### 3.1 Tags (标签表)
系统标签主表，用于用户兴趣匹配。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 标签ID |
| Name | varchar(50) | NOT NULL | 标签名称 |
| Description | varchar(200) | NULL | 标签描述 |
| Category | int | NOT NULL | 标签分类 |
| UsageCount | int | NOT NULL, DEFAULT 0 | 使用次数 |
| CreatedAt | timestamp | NOT NULL | 创建时间 |
| LastUsedAt | timestamp | NULL | 最后使用时间 |
| IsActive | boolean | NOT NULL, DEFAULT TRUE | 是否激活 |

**索引**:
- UNIQUE INDEX on Name
- INDEX on Category
- INDEX on UsageCount
- INDEX on IsActive

**标签分类 (TagCategory)**:
- 1: Sports (运动健身)
- 2: Gaming (游戏娱乐)
- 3: Learning (学习成长)
- 4: Food (美食餐饮)
- 5: Travel (旅游出行)
- 6: Music (音乐艺术)
- 7: Technology (科技数码)
- 8: Fashion (时尚美容)
- 9: Reading (读书阅读)
- 99: Other (其他)

#### 3.2 UserTags (用户标签关系表)
记录用户选择的标签及权重。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 记录ID |
| UserId | uuid | NOT NULL | 用户ID |
| TagId | uuid | FK, NOT NULL | 标签ID |
| Weight | float | NOT NULL | 权重（0-1，表示兴趣程度） |
| CreatedAt | timestamp | NOT NULL | 创建时间 |
| LastUpdatedAt | timestamp | NOT NULL | 最后更新时间 |
| IsActive | boolean | NOT NULL | 是否激活 |

**索引**:
- INDEX on UserId
- INDEX on TagId
- INDEX on (UserId, TagId)

**外键关系**:
- TagId → Tags(Id)

#### 3.3 UserMatches (用户匹配记录表)
记录用户之间的匹配关系和分数。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 记录ID |
| UserId | uuid | NOT NULL | 用户ID |
| MatchedUserId | uuid | NOT NULL | 匹配的用户ID |
| MatchScore | float | NOT NULL | 匹配分数（0-1） |
| MatchType | int | NOT NULL | 匹配类型 |
| Status | int | NOT NULL | 匹配状态 |
| CreatedAt | timestamp | NOT NULL | 创建时间 |
| LastInteractionAt | timestamp | NULL | 最后交互时间 |
| Notes | text | NULL | 备注信息 |

**索引**:
- INDEX on UserId
- INDEX on MatchedUserId
- INDEX on MatchScore
- INDEX on Status

**匹配类型 (MatchType)**:
- 1: TagBased (基于标签的匹配)
- 2: CollaborativeFiltering (基于协同过滤的匹配)
- 3: LocationBased (基于地理位置的匹配)
- 4: ActivityBased (基于活跃度的匹配)
- 5: Hybrid (混合推荐)
- 6: Random (随机推荐)

**匹配状态 (MatchStatus)**:
- 1: Pending (待处理)
- 2: Accepted (已接受)
- 3: Rejected (已拒绝)
- 4: Expired (已过期)
- 5: Cancelled (已取消)

#### 3.4 UserInteractions (用户交互记录表)
记录用户之间的交互行为，用于协同过滤算法。

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| Id | uuid | PK, NOT NULL | 记录ID |
| UserId | uuid | NOT NULL | 用户ID |
| TargetUserId | uuid | NOT NULL | 目标用户ID |
| Type | int | NOT NULL | 交互类型 |
| Rating | float | NOT NULL | 评分（0-5） |
| CreatedAt | timestamp | NOT NULL | 创建时间 |
| Context | text | NULL | 交互上下文 |
| Metadata | text | NULL | 元数据 |

**索引**:
- INDEX on UserId
- INDEX on TargetUserId
- INDEX on Type
- INDEX on CreatedAt

**交互类型 (InteractionType)**:
- 1: ViewProfile (查看资料)
- 2: SendMessage (发送消息)
- 3: Like (点赞)
- 4: Follow (关注)
- 5: Comment (评论)
- 6: Share (分享)
- 7: Report (举报)
- 8: JoinGroup (加入群组)
- 9: JoinActivity (参与活动)

---

## 4. ChatService 数据库 (MongoDB)

### 数据库配置
- **数据库名称**: `chatdb`
- **DBMS**: MongoDB
- **默认连接**: `mongodb://localhost:27017`

### 集合结构

#### 4.1 messages (消息集合)
存储所有聊天消息（私聊和群聊）。

**文档结构**:
```json
{
  "_id": ObjectId,
  "Type": "private" | "group",
  "FromUserId": "string",
  "ToUserId": "string",      // 私聊时使用
  "GroupId": "string",        // 群聊时使用
  "Content": "string",
  "CreatedAt": ISODate,
  "MessageType": "text" | "image" | "file" | "emoji",
  "Status": "sent" | "delivered" | "read",
  "Metadata": {}              // 额外的元数据信息
}
```

**索引**:
- Compound Index: `{ Type: 1, FromUserId: 1, ToUserId: 1, CreatedAt: 1 }`
- Compound Index: `{ Type: 1, GroupId: 1, CreatedAt: 1 }`

**特性**:
- 灵活的文档结构适合存储各种类型的消息
- 支持私聊和群聊消息
- 高性能的消息查询和检索

#### 4.2 conversations (对话集合)
用于管理对话列表（可能在初始化脚本中创建）。

**文档结构**:
```json
{
  "_id": ObjectId,
  "participants": ["userId1", "userId2"],
  "lastMessage": {
    "content": "string",
    "timestamp": ISODate,
    "senderId": "string"
  },
  "unreadCount": {
    "userId1": 0,
    "userId2": 0
  }
}
```

**索引**:
- Index on participants

#### 4.3 users (用户在线状态)
可能用于存储用户的在线状态信息（主要使用Redis）。

**文档结构**:
```json
{
  "_id": ObjectId,
  "userId": "string",
  "username": "string",
  "email": "string",
  "lastOnline": ISODate,
  "status": "online" | "offline" | "away"
}
```

**索引**:
- UNIQUE Index on username
- UNIQUE Index on email

---

## 5. Redis 缓存系统

### 使用场景

Redis在本系统中主要用于：

#### 5.1 UserManager服务
- **验证码缓存**: 存储短信/邮箱验证码（有效期5-10分钟）
- **Token黑名单**: 存储已注销的JWT Token
- **用户会话**: 存储用户登录会话信息

**Key命名规范**:
```
user:verification:phone:{phoneNumber}
user:verification:email:{email}
user:session:{userId}
user:token:blacklist:{tokenId}
```

#### 5.2 ForumManager服务
- **帖子缓存**: 缓存热门帖子内容
- **统计数据**: 缓存浏览量、点赞数等计数器
- **查询结果**: 缓存热门帖子列表、推荐帖子等

**Key命名规范**:
```
forum:post:{postId}
forum:hot:posts
forum:user:{userId}:posts
forum:category:{category}:posts
```

#### 5.3 MatchingService服务
- **推荐结果**: 缓存用户推荐结果（5分钟）
- **热门标签**: 缓存热门标签列表（10分钟）
- **用户标签**: 缓存用户标签数据（15分钟）

**Key命名规范**:
```
matching:recommendations:{userId}
matching:tags:popular
matching:user:{userId}:tags
matching:user:{userId}:matches
```

**缓存配置**:
- UserRecommendationsExpirationMinutes: 5
- PopularTagsExpirationMinutes: 10
- UserTagsExpirationMinutes: 15

#### 5.4 ChatService服务
- **在线状态**: 用户在线/离线状态管理
- **连接映射**: SignalR ConnectionId 与 UserId 的映射
- **未读消息**: 未读消息计数

**Key命名规范**:
```
chat:online:{userId}
chat:connection:{connectionId}
chat:unread:{userId}
presence:user:{userId}:connections
```

### Redis配置
- **默认连接**: `localhost:6379`
- **持久化**: 支持AOF和RDB
- **过期策略**: 根据业务场景设置不同的过期时间

---

## 6. 数据库关系图

### 跨服务数据关联

虽然每个服务使用独立的数据库，但通过 **UserId** 实现逻辑关联：

```
UserManager.Users(Id) 
    ↓
    ├── ForumManager.Posts(AuthorId)
    ├── ForumManager.Comments(AuthorId)
    ├── MatchingService.UserTags(UserId)
    ├── MatchingService.UserMatches(UserId)
    ├── ChatService.messages(FromUserId/ToUserId)
    └── Redis (各种缓存键)
```

### 数据一致性策略

1. **最终一致性**: 通过事件驱动实现跨服务数据同步
2. **补偿机制**: 使用Saga模式处理分布式事务
3. **缓存失效**: Redis缓存自动过期和手动清除

---

## 7. 数据库性能优化

### 7.1 索引策略

#### PostgreSQL索引
- 主键索引（自动）
- 外键索引（显式创建）
- 业务查询字段索引（如时间、状态、分类等）
- 联合索引用于多字段查询

#### MongoDB索引
- 复合索引支持复杂查询
- 根据查询模式优化索引顺序

### 7.2 查询优化

1. **分页查询**: 所有列表查询都支持分页
2. **延迟加载**: 使用Include()按需加载关联数据
3. **缓存优先**: 热点数据优先从Redis读取
4. **读写分离**: 可扩展为主从架构

### 7.3 数据清理策略

1. **软删除**: 重要数据使用IsDeleted标记
2. **历史归档**: 定期归档旧数据
3. **日志轮转**: 登录历史按时间分区

---

## 8. 数据库备份与恢复

### 8.1 PostgreSQL备份

```bash
# 备份单个数据库
pg_dump -h localhost -U postgres -d usermanagerdb > usermanagerdb_backup.sql
pg_dump -h localhost -U postgres -d ForumDB > forumdb_backup.sql
pg_dump -h localhost -U postgres -d MatchingDB > matchingdb_backup.sql

# 恢复数据库
psql -h localhost -U postgres -d usermanagerdb < usermanagerdb_backup.sql
```

### 8.2 MongoDB备份

```bash
# 备份
mongodump --db chatdb --out /backup/chatdb

# 恢复
mongorestore --db chatdb /backup/chatdb/chatdb
```

### 8.3 Redis备份

```bash
# 触发保存
redis-cli BGSAVE

# RDB文件位置
/var/lib/redis/dump.rdb

# AOF文件
/var/lib/redis/appendonly.aof
```

---

## 9. 数据库安全

### 9.1 访问控制
- PostgreSQL: 使用独立的数据库用户，限制权限
- MongoDB: 启用认证，为每个数据库创建专用用户
- Redis: 设置密码保护（生产环境）

### 9.2 数据加密
- 密码使用MD5哈希存储
- 敏感信息不存储在数据库（如支付信息）
- SSL/TLS连接（生产环境推荐）

### 9.3 SQL注入防护
- 使用Entity Framework Core参数化查询
- 输入验证和过滤
- 最小权限原则

---

## 10. 数据库迁移

### 10.1 Entity Framework Core Migrations

#### UserManager
```bash
cd UserManager/UserManager.Infrastracture
dotnet ef migrations add MigrationName
dotnet ef database update
```

#### ForumManager
```bash
cd ForumManager/ForumManager.Infrastructure
dotnet ef migrations add MigrationName
dotnet ef database update
```

#### MatchingService
```bash
cd MatchingService/MatchingService.Infrastructure
dotnet ef migrations add MigrationName
dotnet ef database update
```

### 10.2 MongoDB Schema Evolution
MongoDB使用灵活的Schema，通过应用程序代码管理Schema变更。

---

## 11. 监控与维护

### 11.1 性能监控

**PostgreSQL**:
```sql
-- 查看慢查询
SELECT * FROM pg_stat_statements 
ORDER BY mean_time DESC LIMIT 10;

-- 查看表大小
SELECT schemaname, tablename, 
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) 
FROM pg_tables 
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

**MongoDB**:
```javascript
// 查看集合统计
db.messages.stats()

// 查看慢查询
db.getProfilingStatus()
db.system.profile.find().sort({ts:-1}).limit(5)
```

**Redis**:
```bash
# 查看内存使用
redis-cli INFO memory

# 查看慢查询日志
redis-cli SLOWLOG GET 10
```

### 11.2 定期维护

1. **PostgreSQL**:
   - VACUUM ANALYZE（每周）
   - REINDEX（按需）
   - 更新统计信息

2. **MongoDB**:
   - 检查索引使用情况
   - 压缩集合
   - 监控复制集状态

3. **Redis**:
   - 检查内存使用
   - 清理过期键
   - AOF重写

---

## 12. 环境配置

### 12.1 开发环境

**PostgreSQL**: localhost:5432
**MongoDB**: localhost:27017
**Redis**: localhost:6379

### 12.2 生产环境

建议使用Docker Compose部署，每个服务的docker-compose文件已配置：
- 自动健康检查
- 数据持久化
- 网络隔离
- 资源限制

### 12.3 连接字符串配置

所有连接字符串配置在各服务的 `appsettings.json` 中：

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "数据库连接字符串",
    "Redis": "Redis连接字符串"
  }
}
```

---

## 附录

### A. 数据库统计信息

| 数据库 | 表/集合数 | 预计数据量 | 存储需求 |
|-------|----------|-----------|---------|
| usermanagerdb | 3 | 10万用户 | ~100MB |
| ForumDB | 5 | 100万帖子 | ~10GB |
| MatchingDB | 4 | 500万关系 | ~5GB |
| chatdb | 3 | 1000万消息 | ~50GB |

### B. 相关文档

- [UserManager API文档](UserManager/API接口文档.md)
- [ForumManager API文档](ForumManager/ForumManager.WebAPI/API接口文档.md)
- [MatchingService API文档](MatchingService/API接口文档.md)
- [ChatService API文档](ChatService/API_DOCUMENTATION.md)

### C. 技术栈版本

- .NET: 8.0
- Entity Framework Core: 9.0
- PostgreSQL: 14+
- MongoDB: 7.0
- Redis: 7.2
- Docker: 20.10+

---

**文档版本**: 1.0
**最后更新**: 2024年10月
**维护者**: 开发团队


